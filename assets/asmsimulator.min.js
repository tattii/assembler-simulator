/*! asmsimulator 28-05-2015 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",[function(){return{go:function(a){for(var b=/^[\t ]*([A-Za-z]+)(?:[\t ]+([\w\-]+)[\t ]*?(?:,[\t ]*?([\w\-\(\)]+))*)*/,c=/^[-+]?[0-9]+$/,d=/^R([0-7])$/,e=/^(.*?)\((.*?)\)$/,f=[],g=a.split("\n"),h=function(a){if(void 0===a)throw"undefined d";if("0x"===a.slice(0,2))return parseInt(a.slice(2),16);if("0o"===a.slice(0,2))return parseInt(a.slice(2),8);if("b"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),2);if("d"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),10);if(c.exec(a))return parseInt(a,10);throw"Invalid number format"},i=function(a){if(void 0===a)throw"undefined register";return a=a.toUpperCase(),a.match(d)?parseInt(RegExp.$1):void 0},j=function(a){if(void 0===a)throw"undefined Memory address";if(a.match(e))return{d:parseInt(RegExp.$1),rb:i(RegExp.$2)};throw"invalid Memory address"},k=function(a,b){if(void 0===a&&(a=""),a.length>=b)return a;var c="0".repeat(b);return(c+a).slice(-1*b)},l=function(a){return parseInt(a,2)},m=function(a){return k(a.toString(2),3)},n=function(a){return k(a.toString(2),4)},o=function(a){return a>=0?k(a.toString(2),8):"1"+k((a+128).toString(2),7)},p=function(a){return parseInt(a,16)},q={ADD:"0000",SUB:"0001",AND:"0010",OR:"0011",XOR:"0100",CMP:"0101",MOV:"0110"},r={SLL:"1000",SLR:"1001",SRL:"1010",SRA:"1011"},s={BE:"000",BLT:"001",BLE:"010",BNE:"011"},t=0,u=g.length;u>t;t++)try{var v=b.exec(g[t]);if(void 0!==v[1]){var w,x,y,z=v[1].toUpperCase();switch(z){case"ADD":case"SUB":case"AND":case"OR":case"XOR":case"CMP":case"MOV":w=i(v[2]),x=i(v[3]),y=l("11"+m(x)+m(w)+q[z]+"0000"),f.push({op:z,code:y,rd:w,rs:x});break;case"SLL":case"SLR":case"SRL":case"SRA":w=i(v[2]),x=h(v[3]),y=l("11000"+m(w)+r[z]+n(x)),f.push({op:z,code:y,rd:w,d:x});break;case"OUT":w=i(v[2]),y=l("11"+m(w)+"00011010000"),f.push({op:"OUT",code:y,rs:w});break;case"HLT":y=p("c0f0"),f.push({op:"HLT",code:y});break;case"LD":case"ST":w=i(v[2]),x=j(v[3]);var A="LD"==z?"00":"01";y=l(A+m(w)+m(x.rb)+o(x.d)),f.push({op:z,code:y,ra:w,rb:x.rb,d:x.d});break;case"LI":w=i(v[2]),x=h(v[3]),y=l("10000"+m(w)+o(x)),f.push({op:"LI",code:y,rb:w,d:x});break;case"ADDI":w=i(v[2]),x=h(v[3]),y=l("10001"+m(w)+o(x)),f.push({op:"ADDI",code:y,rb:w,d:x});break;case"B":w=h(v[2]),y=l("10100000"+o(w)),f.push({op:"B",code:y,d:w});break;case"BE":case"BLT":case"BLE":case"BNE":w=h(v[2]),y=l("10111"+s[z]+o(w)),f.push({op:z,code:y,d:w});break;default:throw"Invalid instruction: "+v[1]}}else{var B=g[t].trim();if(""!==B&&";"!==B.slice(0,1))throw"Syntax error"}}catch(C){throw{error:C,line:t}}return f}}}]),app.service("cpu",["memory",function(a){var b={step:function(){var b=this;try{var c=function(c){if(0>c||c>=a.data.length)throw"PC outside memory";b.pc=c};if(b.pc<0||b.pc>=a.data.length)throw"Program Counter is outside of memory";var d=a.loadInstr(b.pc);b.count++;var e=0,f=0,g=0;switch(console.log(d),d.op){case"HLT":return!1;case"ADD":b.gpr[d.rd]=b.gpr[d.rd]+b.gpr[d.rs],b.pc++;break;case"SUB":b.gpr[d.rd]=b.gpr[d.rd]-b.gpr[d.rs],b.pc++;break;case"AND":b.gpr[d.rd]=b.gpr[d.rd]&b.gpr[d.rs],b.pc++;break;case"OR":b.gpr[d.rd]=b.gpr[d.rd]|b.gpr[d.rs],b.pc++;break;case"XOR":b.gpr[d.rd]=b.gpr[d.rd]^b.gpr[d.rs],b.pc++;break;case"CMP":var h=b.gpr[d.rd]-b.gpr[d.rs];console.log("CMP"+b.gpr[d.rd]+","+b.gpr[d.rs]+"="+h),0===h&&(e=1),0>h&&(f=1),(h>32768||-32769>h)&&(g=1),b.pc++;break;case"MOV":b.gpr[d.rd]=b.gpr[d.rs],b.pc++;break;case"OUT":b.output=b.gpr[d.rs],b.pc++;break;case"SLL":b.gpr[d.rd]=b.gpr[d.rd]<<d.d,b.pc++;break;case"SLR":b.gpr[d.rd]=(b.gpr[d.rd]<<d.d)+(b.gpr[d.rd]>>>16-d.d),b.pc++;break;case"SRL":b.gpr[d.rd]=b.gpr[d.rd]>>>d.d,b.pc++;break;case"SRA":b.gpr[d.rd]=b.gpr[d.rd]>>d.d,b.pc++;break;case"LD":b.gpr[d.ra]=a.load(b.gpr[d.rb]+d.d),b.pc++;break;case"ST":a.store(b.gpr[d.rb]+d.d,b.gpr[d.ra]),b.pc++;break;case"LI":b.gpr[d.rb]=d.d,b.pc++;break;case"ADDI":b.gpr[d.rb]=b.gpr[d.rb]+d.d,b.pc++;break;case"B":c(b.pc+1+d.d);break;case"BE":b.zero?c(b.pc+1+d.d):b.pc++;break;case"BLT":b.sign^b.v?c(b.pc+1+d.d):b.pc++;break;case"BLE":b.zero|b.sign^b.v?c(b.pc+1+d.d):b.pc++;break;case"BNE":b.zero?b.pc++:c(b.pc+1+d.d);break;default:throw"Invalid op code: "+d.op}return b.zero=e,b.sign=f,b.v=g,!0}catch(i){throw b.fault=!0,i}},reset:function(){var a=this;a.gpr=[0,0,0,0,0,0,0,0],a.pc=0,a.sign=0,a.zero=0,a.v=0,a.output=0,a.count=0}};return b.reset(),b}]),app.service("memory",[function(){var a={data:Array(256),lastAccess:-1,load:function(a){var b=this;if(0>a||a>=b.data.length)throw"Memory access violation at "+a;return b.lastAccess=a,b.data[a]},loadInstr:function(a){var b=this;if(0>a||a>=b.data.length)throw"Memory access violation at "+a;return b.lastAccess=a,b.instrs[a]},store:function(a,b){var c=this;if(0>a||a>=c.data.length)throw"Memory access violation at "+a;c.lastAccess=a,c.data[a]=b},reset:function(){var a=this;a.lastAccess=-1,a.instrs&&(a.instrs=null);for(var b=0,c=a.data.length/2;c>b;b++)a.data[b]=0;for(var d=a.data.length/2,e=a.data.length;e>d;d++)a.data[d]=Math.floor(1024*Math.random())}};return a.reset(),a}]),app.service("opcodes",[function(){var a={NONE:0,MOV_REG_TO_REG:1,MOV_ADDRESS_TO_REG:2,MOV_REGADDRESS_TO_REG:3,MOV_REG_TO_ADDRESS:4,MOV_REG_TO_REGADDRESS:5,MOV_NUMBER_TO_REG:6,MOV_NUMBER_TO_ADDRESS:7,MOV_NUMBER_TO_REGADDRESS:8,ADD_REG_TO_REG:10,ADD_REGADDRESS_TO_REG:11,ADD_ADDRESS_TO_REG:12,ADD_NUMBER_TO_REG:13,SUB_REG_FROM_REG:14,SUB_REGADDRESS_FROM_REG:15,SUB_ADDRESS_FROM_REG:16,SUB_NUMBER_FROM_REG:17,INC_REG:18,DEC_REG:19,CMP_REG_WITH_REG:20,CMP_REGADDRESS_WITH_REG:21,CMP_ADDRESS_WITH_REG:22,CMP_NUMBER_WITH_REG:23,JMP_REGADDRESS:30,JMP_ADDRESS:31,JC_REGADDRESS:32,JC_ADDRESS:33,JNC_REGADDRESS:34,JNC_ADDRESS:35,JZ_REGADDRESS:36,JZ_ADDRESS:37,JNZ_REGADDRESS:38,JNZ_ADDRESS:39,JA_REGADDRESS:40,JA_ADDRESS:41,JNA_REGADDRESS:42,JNA_ADDRESS:43,PUSH_REG:50,PUSH_REGADDRESS:51,PUSH_ADDRESS:52,PUSH_NUMBER:53,POP_REG:54,CALL_REGADDRESS:55,CALL_ADDRESS:56,RET:57,MUL_REG:60,MUL_REGADDRESS:61,MUL_ADDRESS:62,MUL_NUMBER:63,DIV_REG:64,DIV_REGADDRESS:65,DIV_ADDRESS:66,DIV_NUMBER:67,AND_REG_WITH_REG:70,AND_REGADDRESS_WITH_REG:71,AND_ADDRESS_WITH_REG:72,AND_NUMBER_WITH_REG:73,OR_REG_WITH_REG:74,OR_REGADDRESS_WITH_REG:75,OR_ADDRESS_WITH_REG:76,OR_NUMBER_WITH_REG:77,XOR_REG_WITH_REG:78,XOR_REGADDRESS_WITH_REG:79,XOR_ADDRESS_WITH_REG:80,XOR_NUMBER_WITH_REG:81,NOT_REG:82,SHL_REG_WITH_REG:90,SHL_REGADDRESS_WITH_REG:91,SHL_ADDRESS_WITH_REG:92,SHL_NUMBER_WITH_REG:93,SHR_REG_WITH_REG:94,SHR_REGADDRESS_WITH_REG:95,SHR_ADDRESS_WITH_REG:96,SHR_NUMBER_WITH_REG:97};return a}]),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","assembler",function(a,b,c,d,e,f){b.memory=e,b.cpu=d,b.error="",b.isRunning=!1,b.displayHex=!0,b.displayInstr=!0,b.displayA=!1,b.displayB=!0,b.displayC=!0,b.displayD=!0,b.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"}],b.speed=4,b.dataStartIndex=128,b.code="LI R1, 128\nLI R3, 128\nADDI R3, 7\nMOV R2, R1\nLD R4, 0(R2)\nLD R5, 1(R2)\nCMP R4, R5\nBLE 2\nST R4, 1(R2)\nST R5, 0(R2)\nADDI R2, 1\nCMP R2, R3\nBLT -9\nADDI R1, 1\nCMP R1, R3\nBLT -13\nHLT",b.reset=function(){d.reset(),e.reset(),b.error="",b.selectedLine=-1},b.executeStep=function(){b.checkPrgrmLoaded()||b.assemble();try{b.selectedLine=d.pc;var a=d.step();return a}catch(c){return b.error=c,!1}};var g;b.run=function(){b.checkPrgrmLoaded()||b.assemble(),b.isRunning=!0,g=c(function(){b.executeStep()===!0?b.run():b.isRunning=!1},1e3/b.speed)},b.stop=function(){c.cancel(g),b.isRunning=!1},b.checkPrgrmLoaded=function(){for(var a=0,b=e.data.length/2;b>a;a++)if(0!==e.data[a])return!0;return!1},b.getChar=function(a){var b=String.fromCharCode(a);return""===b.trim()?"  ":b},b.assemble=function(){try{b.reset();var a=f.go(b.code);if(e.instrs=a,a.length>e.data.length)throw"Binary code does not fit into the memory. Max "+e.data.length+" bytes are allowed";for(var c=0,d=a.length;d>c;c++)e.data[c]=a[c].code}catch(g){void 0!==g.line?(b.error=g.line+" | "+g.error,b.selectedLine=g.line):b.error=g.error}},b.jumpToLine=function(c){a[0].getElementById("sourceCode").scrollIntoView(),b.selectedLine=b.mapping[c]},b.isInstruction=function(a){return void 0!==b.mapping&&void 0!==b.mapping[a]&&b.displayInstr},b.getMemoryCellCss=function(a){return a>=b.dataStartIndex?"output-bg":b.isInstruction(a)?"instr-bg":""},b.getMemoryInnerCellCss=function(a){return a===d.pc?"marker marker-ip":a===d.gpr[0]&&b.displayA?"marker marker-a":a===d.gpr[1]&&b.displayB?"marker marker-b":a===d.gpr[2]&&b.displayC?"marker marker-c":a===d.gpr[3]&&b.displayD?"marker marker-d":""}}]),app.filter("flag",function(){return function(a){return a.toString().toUpperCase()}}),app.filter("number",function(){return function(a,b){function c(a,b){if(void 0===a&&(a=""),a.length>=b)return a;var c="0".repeat(b);return(c+a).slice(-1*b)}if(b){var d=a.toString(16).toUpperCase();return c(d,4)}return a.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(a,b,c,d){a.$watch("selectedLine",function(){if(a.selectedLine>=0){for(var c=b[0].value.split("\n"),d=0,e=0;e<c.length&&e!=a.selectedLine;e++)d+=c[e].length+1;var f=c[a.selectedLine].length+d;if("undefined"!=typeof b[0].selectionStart&&(b[0].focus(),b[0].selectionStart=d,b[0].selectionEnd=f),document.selection&&document.selection.createRange){b[0].focus(),b[0].select();var g=document.selection.createRange();g.collapse(!0),g.moveEnd("character",f),g.moveStart("character",d),g.select()}}})}}}]),app.filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(a,b,c,d){b.bind("keydown",function(a){if(9===a.keyCode){var b=this.value,c=this.selectionStart,d=this.selectionEnd;return this.value=b.substring(0,c)+"	"+b.substring(d),this.selectionStart=this.selectionEnd=c+1,a.preventDefault(),!1}})}}}]);